<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPJS & Casemix Integration Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bpjs: { 500: '#00A651', 600: '#008C44' }, // Official BPJS Green
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-bpjs-500 text-white p-2 rounded-lg">
                <i class="fa-solid fa-notes-medical"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg">Modul Integrasi BPJS & Casemix</h1>
                <p class="text-xs text-gray-500">Bridging V-Claim v2.0 & E-Klaim 5.x</p>
            </div>
        </div>
        <div class="text-right">
            <span class="block text-sm font-semibold">Petugas: Ratna Sari</span>
            <span class="text-xs text-gray-500">Unit Casemix</span>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-12 gap-6">

        <!-- LEFT COL: Patient & Eligibility (V-CLAIM) -->
        <section class="col-span-12 lg:col-span-4 space-y-6">
            
            <!-- 1. Eligibility Check Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-bpjs-500 to-emerald-600 px-5 py-4 flex justify-between items-center">
                    <h2 class="text-white font-bold flex items-center gap-2">
                        <i class="fa-solid fa-id-card"></i> Cek Kepesertaan (V-Claim)
                    </h2>
                    <span class="bg-white/20 text-white text-xs px-2 py-1 rounded">Online</span>
                </div>
                
                <div class="p-5">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nomor Kartu BPJS / NIK</label>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="bpjs-input" value="000123456788" 
                               class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-bpjs-500 outline-none" 
                               placeholder="000xxxxxxxx">
                        <button onclick="checkEligibility()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                            <i class="fa-solid fa-magnifying-glass"></i> Cek
                        </button>
                    </div>

                    <!-- Result Status (Hidden by default) -->
                    <div id="eligibility-result" class="hidden animate-fade-in">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-green-100 p-2 rounded-full text-green-600">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-green-800 text-sm">Peserta Aktif</p>
                                    <p class="text-xs text-green-600">Hak Kelas: <span id="res-class" class="font-bold">Kelas 1</span></p>
                                </div>
                            </div>
                            <div class="border-t border-green-200 my-2"></div>
                            <div class="grid grid-cols-2 gap-y-2 text-xs text-gray-600">
                                <span>Nama:</span> <span class="font-semibold text-right" id="res-name">Budi Santoso</span>
                                <span>NIK:</span> <span class="font-mono text-right">3515...0001</span>
                                <span>Faskes 1:</span> <span class="text-right">Puskesmas Waru</span>
                            </div>
                        </div>

                        <!-- Generate SEP Action -->
                        <button onclick="generateSEP()" id="btn-create-sep"
                                class="w-full bg-bpjs-500 hover:bg-bpjs-600 text-white py-2 rounded-lg text-sm font-bold shadow-sm flex justify-center items-center gap-2">
                            <i class="fa-solid fa-file-contract"></i> Terbitkan SEP
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Active SEP Info -->
            <div id="sep-card" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hidden relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-gray-50 opacity-10 pointer-events-none">
                    <i class="fa-solid fa-file-signature text-9xl"></i>
                </div>
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">SEP Aktif</h3>
                <div class="space-y-3 relative z-10">
                    <div>
                        <label class="text-xs text-gray-400">No. SEP</label>
                        <p class="font-mono font-bold text-lg text-blue-600" id="sep-number">1301R001...</p>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Tanggal</label>
                        <p class="text-sm font-medium" id="sep-date">-</p>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Diagnosa Awal</label>
                        <p class="text-sm font-medium">A01.0 - Typhoid Fever</p>
                    </div>
                </div>
            </div>

        </section>

        <!-- RIGHT COL: Coding & Grouping (INA-CBG) -->
        <section class="col-span-12 lg:col-span-8 flex flex-col gap-6">
            
            <!-- 3. Medical Coding Input -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-lg text-gray-800">Coding & Grouping (Simulasi INA-CBG)</h2>
                    <button onclick="resetCoding()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Reset Form</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Diagnosis Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Diagnosa (ICD-10)</label>
                        <div class="relative">
                            <i class="fa-solid fa-stethoscope absolute left-3 top-3 text-gray-400"></i>
                            <select id="icd10-select" class="w-full pl-10 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white">
                                <option value="" disabled selected>Pilih Diagnosa Utama...</option>
                                <option value="A01.0">A01.0 - Typhoid Fever</option>
                                <option value="I10">I10 - Essential Hypertension</option>
                                <option value="E11.9">E11.9 - Diabetes Mellitus Type 2</option>
                                <option value="K35.8">K35.8 - Acute Appendicitis</option>
                            </select>
                        </div>
                        
                        <div class="mt-3">
                            <label class="block text-xs text-gray-500 mb-1">Diagnosa Sekunder (Komorbid)</label>
                            <div id="secondary-diag-list" class="space-y-2">
                                <!-- Dynamic JS items -->
                            </div>
                            <button onclick="addSecondary()" class="mt-2 text-xs text-blue-600 font-bold flex items-center gap-1 hover:underline">
                                <i class="fa-solid fa-plus"></i> Tambah Sekunder
                            </button>
                        </div>
                    </div>

                    <!-- Procedure Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tindakan (ICD-9-CM)</label>
                        <div class="relative">
                            <i class="fa-solid fa-scalpel absolute left-3 top-3 text-gray-400"></i>
                            <select id="icd9-select" class="w-full pl-10 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white">
                                <option value="">Tidak ada prosedur...</option>
                                <option value="89.52">89.52 - ECG</option>
                                <option value="47.0">47.0 - Appendectomy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="simulateGrouper()" id="btn-group" disabled
                            class="bg-gray-300 text-gray-500 px-6 py-2.5 rounded-lg font-bold shadow-sm transition-all flex items-center gap-2">
                        <i class="fa-solid fa-calculator"></i> Hitung Grouping
                    </button>
                </div>
            </div>

            <!-- 4. Grouping Result & Split Billing Preview -->
            <div id="grouping-result" class="hidden bg-slate-800 text-white rounded-xl shadow-lg p-6 relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                    
                    <!-- Result Left: INA-CBG Details -->
                    <div class="border-r border-white/10 pr-8">
                        <h3 class="text-white/60 text-xs font-bold uppercase tracking-wider mb-4">Hasil Grouping (E-Klaim)</h3>
                        
                        <div class="mb-6">
                            <span class="bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded">CODE</span>
                            <h2 class="text-3xl font-bold mt-1" id="res-inacbg-code">A-4-10-I</h2>
                            <p class="text-lg font-light text-blue-200" id="res-desc">Typhoid Fever (Ringan)</p>
                        </div>

                        <div class="flex gap-4">
                            <div>
                                <p class="text-xs text-white/50">Severity</p>
                                <p class="font-bold text-lg" id="res-severity">Level I</p>
                            </div>
                            <div>
                                <p class="text-xs text-white/50">Tarif INA-CBG</p>
                                <p class="font-bold text-lg text-green-400" id="res-tariff">Rp 4.500.000</p>
                            </div>
                        </div>
                    </div>

                    <!-- Result Right: Billing Implication -->
                    <div class="flex flex-col justify-center">
                        <h3 class="text-white/60 text-xs font-bold uppercase tracking-wider mb-4">Estimasi Split Tagihan</h3>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-white/80">Total Tagihan RS (Real)</span>
                                <span class="font-bold" id="bill-real">Rp 5.200.000</span>
                            </div>
                            <div class="flex justify-between items-center text-green-400">
                                <span class="flex items-center gap-1"><i class="fa-solid fa-shield-heart"></i> Cover BPJS</span>
                                <span class="font-bold" id="bill-covered">- Rp 4.500.000</span>
                            </div>
                            <div class="h-px bg-white/20 my-2"></div>
                            <div class="flex justify-between text-lg">
                                <span class="font-bold text-orange-300">Selisih / Eksese</span>
                                <span class="font-bold text-orange-300" id="bill-excess">Rp 700.000</span>
                            </div>
                        </div>

                        <div class="mt-4 bg-orange-500/20 border border-orange-500/30 rounded p-3">
                            <p class="text-xs text-orange-200 leading-tight">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                                Tagihan RS melebihi tarif paket INA-CBG. Selisih ditanggung RS (kecuali naik kelas VIP).
                            </p>
                        </div>
                    </div>

                </div>
            </div>

        </section>
    </main>

    <!-- JS Logic -->
    <script>
        // --- Variables matching Schema ---
        let currentPatient = {
            bpjs_card_no: '',
            bpjs_class_id: 3, // Default class
            sep_no: null
        };

        // --- Mock Bill Data (To simulate Split Billing) ---
        const currentBillTotal = 5200000; 

        // 1. Check Eligibility Function
        function checkEligibility() {
            const cardNo = document.getElementById('bpjs-input').value;
            const btn = document.querySelector('button[onclick="checkEligibility()"]');
            const resultDiv = document.getElementById('eligibility-result');

            // Loading state
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            
            setTimeout(() => {
                // Mock Backend Logic
                if(cardNo.endsWith('0')) {
                    alert("Peserta Tidak Aktif / Tunggakan");
                    btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Cek';
                    return;
                }

                // Simulate Class logic based on last digit (Even=1, Odd=3)
                const cls = parseInt(cardNo.slice(-1)) % 2 === 0 ? 1 : 3;
                currentPatient.bpjs_class_id = cls;
                currentPatient.bpjs_card_no = cardNo;

                // Update UI
                document.getElementById('res-class').innerText = `Kelas ${cls}`;
                document.getElementById('res-name').innerText = "Budi Santoso (Simulasi)";
                
                resultDiv.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Cek';
                
                // Enable Grouper Button
                document.getElementById('btn-group').disabled = false;
                document.getElementById('btn-group').classList.remove('bg-gray-300', 'text-gray-500');
                document.getElementById('btn-group').classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }, 800);
        }

        // 2. Generate SEP
        function generateSEP() {
            const btn = document.getElementById('btn-create-sep');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Memproses V-Claim...';

            setTimeout(() => {
                const randomId = Math.floor(Math.random() * 100000);
                const today = new Date().toISOString().slice(0,10);
                const sep = `1301R001${today.replace(/-/g,'')}V${randomId}`;
                
                currentPatient.sep_no = sep;

                // Hide create button, show card
                document.getElementById('eligibility-result').classList.add('hidden');
                
                const sepCard = document.getElementById('sep-card');
                sepCard.classList.remove('hidden');
                document.getElementById('sep-number').innerText = sep;
                document.getElementById('sep-date').innerText = today;

            }, 1000);
        }

        // 3. Add Secondary Diagnosis
        function addSecondary() {
            const container = document.getElementById('secondary-diag-list');
            const div = document.createElement('div');
            div.className = 'flex gap-2 animate-fade-in';
            div.innerHTML = `
                <select class="sec-diag-select w-full border border-gray-300 rounded px-2 py-1.5 text-xs">
                    <option value="E11.9">E11.9 - Diabetes Mellitus</option>
                    <option value="I10">I10 - Hypertension</option>
                    <option value="J06.9">J06.9 - Acute URI</option>
                </select>
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        // 4. Simulate Grouper (INA-CBG)
        function simulateGrouper() {
            const primary = document.getElementById('icd10-select').value;
            const secondaries = document.querySelectorAll('.sec-diag-select');
            
            if(!primary) {
                alert("Pilih diagnosa utama terlebih dahulu!");
                return;
            }

            // Mock Calculation based on Python logic
            // Base Tariffs
            const tariffs = {
                "A01.0": { code: "A-4-10", base: 4500000, name: "Typhoid Fever" },
                "I10":   { code: "I-4-10", base: 3200000, name: "Hypertension" },
                "E11.9": { code: "E-4-10", base: 5100000, name: "Diabetes Mellitus" },
                "K35.8": { code: "K-4-10", base: 8500000, name: "Appendicitis" }
            };

            const data = tariffs[primary];
            
            // Logic: Class Multiplier
            let multiplier = currentPatient.bpjs_class_id === 1 ? 1.4 : 1.0;
            
            // Logic: Severity (based on count of secondaries)
            let severity = 1;
            let severityCode = "I";
            if(secondaries.length === 1) { severity = 2; severityCode = "II"; }
            if(secondaries.length >= 2) { severity = 3; severityCode = "III"; }

            // Final Calc
            const finalTariff = (data.base * multiplier) * (1 + (severity * 0.1)); // simplified math
            
            // Render Result
            const resDiv = document.getElementById('grouping-result');
            resDiv.classList.remove('hidden');

            document.getElementById('res-inacbg-code').innerText = `${data.code}-${severityCode}`;
            document.getElementById('res-desc').innerText = `${data.name} (Severity ${severityCode})`;
            document.getElementById('res-severity').innerText = `Level ${severityCode}`;
            
            // Money Formatting
            const fmt = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
            
            document.getElementById('res-tariff').innerText = fmt(finalTariff);
            document.getElementById('bill-real').innerText = fmt(currentBillTotal);
            document.getElementById('bill-covered').innerText = "- " + fmt(finalTariff);
            
            const excess = currentBillTotal - finalTariff;
            const excessEl = document.getElementById('bill-excess');
            excessEl.innerText = fmt(Math.abs(excess));
            
            if(excess > 0) {
                excessEl.className = "font-bold text-orange-300"; // Loss/Patient Pay
                excessEl.parentElement.previousElementSibling.innerText = "Selisih (Rug/Bayar Sendiri)";
            } else {
                excessEl.className = "font-bold text-green-300"; // Profit
                excessEl.parentElement.previousElementSibling.innerText = "Surplus RS";
            }
        }

        function resetCoding() {
            document.getElementById('icd10-select').value = "";
            document.getElementById('secondary-diag-list').innerHTML = "";
            document.getElementById('grouping-result').classList.add('hidden');
        }
    </script>
</body>
</html>